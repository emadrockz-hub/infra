name: Terraform State Repair (remove force_destroy + bump serial)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-state-repair
  cancel-in-progress: false

jobs:
  repair:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        run: terraform init -reconfigure -input=false -no-color

      - name: Pull remote state (for reference)
        shell: bash
        run: terraform state pull > state.remote.json

      - name: Build repaired state (remove force_destroy + bump serial)
        shell: bash
        run: |
          python3 - << 'PY'
          import json

          remote_path = "state.remote.json"
          out_path = "state.json"

          data = json.load(open(remote_path, "r", encoding="utf-8"))

          remote_serial = int(data.get("serial", 0))
          changed = 0

          for res in data.get("resources", []):
            if res.get("type") == "aws_instance" and res.get("name") == "nginx_ec2":
              for inst in res.get("instances", []):
                attrs = inst.get("attributes", {})
                if "force_destroy" in attrs:
                  del attrs["force_destroy"]
                  changed += 1

          print("REMOTE SERIAL =", remote_serial)
          print("FOUND force_destroy removals =", changed)

          if changed > 0:
            data["serial"] = remote_serial + 1
            print("NEW SERIAL =", data["serial"])
          else:
            print("No change needed; will not push.")

          json.dump(data, open(out_path, "w", encoding="utf-8"), indent=2)
          PY

      - name: Show serials before push
        shell: bash
        run: |
          python3 - << 'PY'
          import json
          r=json.load(open("state.remote.json","r",encoding="utf-8"))
          n=json.load(open("state.json","r",encoding="utf-8"))
          print("REMOTE serial:", r.get("serial"))
          print("NEW    serial:", n.get("serial"))
          PY

      - name: Push repaired state (force)
        shell: bash
        run: |
          python3 - << 'PY'
          import json
          r=json.load(open("state.remote.json","r",encoding="utf-8"))
          n=json.load(open("state.json","r",encoding="utf-8"))
          if r.get("serial") == n.get("serial"):
            raise SystemExit("Serial did not change; refusing to push.")
          PY

          terraform state push -force -lock=true -lock-timeout=5m state.json
